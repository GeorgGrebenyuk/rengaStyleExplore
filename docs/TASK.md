# Задание на разработку

Настоящий документ определяет основные требования и пожелания к составу разрабатываемого продукта -- Renga Style Explorer.

# Краткое описание продукта

Renga Style Explorer - это библиотека (dll), настольное приложение и подключаемый плагин к САПР Renga, предназначение которого -- облегчить и унифицировать хранение стилей объектов Renga, включая стили в самих проектах и стили во внешних файлах, созданных с помощью STDL, использование стилей в модели Renga, составления иллюстрированных каталогов и выполнению иных действий по аналитике и массовой правке стилей.

Все используемые данные (проекты и STDL-исходники) записываются в базу данных и вызываются при необходимости.

# 1. Требования к составу программы

Основная функциональность должна быть реализована в виде динамической библиотеки классов на языке программирования C++ с использованием Qt (5.9.3) для реализации пользовательского интерфейса и работе с системой и базой данных. Дополнительно к библиотеке должно быть реализовано исполняемое приложение (exe) для отображения информации и выполнения действий, не требующих доступа к Renga.

В качестве развития проекта рассмотреть возможность вывода части нативного API через SWIG для вызова оного из-под иных языков программирования.

Функции, требующие взаимодействия с Renga должны быть выведены в отдельную библиотеку, которая будет доступна в виде подключаемого плагина к САПР Renga.

Для сборки стилей в состав дистрибутива должен входить RstBuilder, предусмотреть возможность использования своего.

# 2. Архитектура базы данных

Информацию о стилях Renga предполагается хранить в виде локальной базы данных SQLITE. Далее описывается состав таблиц и колонок для соответствующей информации:

## 2.1. Таблица dbinfo

> Общая информация о БД

| Name  | Type | Description           | Comment |
| ----- | ---- | --------------------- | ------- |
| key   | TEXT | Наименование свойства |         |
| value | TEXT | Значение свойства     |         |

Предполагаемый состав информации:

* DATE.LASTEDIT - дата последнего редактирования базы;

* DATAVASE.LAYOUT - версия настоящей БД;

## 2.2. Таблица paths

> Сведения о путях к данным

| Name   | Type    | Description              | Comment               |
| ------ | ------- | ------------------------ | --------------------- |
| rowid  | INTEGER | Индекс строки            | NOT NULL, PRIMARY KEY |
| data   | TEXT    | Абсолютный файловый путь | NOT NULL              |
| isfile | INTEGER | 1 = файл, 0 = папка      | NOT NULL              |

## 2.3. Таблица bindata

> Сведения о двоичных файлах (чтение файла в память)

| Name  | Type    | Description               | Comment               |
| ----- | ------- | ------------------------- | --------------------- |
| rowid | INTEGER | Индекс строки             | NOT NULL, PRIMARY KEY |
| data  | BLOB    | Двоичное содержимое файла | NOT NULL              |

## 2.4 Таблица projects

> Сведения о файлах Renga (проекты и шаблоны)

| Name          | Type    | Description                           | Comment               |
| ------------- | ------- | ------------------------------------- | --------------------- |
| rowid         | INTEGER | Индекс строки                         | NOT NULL, PRIMARY KEY |
| bindata_rowid | BLOB    | Идентификатор из таблицы bindata      |                       |
| version\*     | TEXT    | Версия Renga, в которой сохранен файл |                       |

\*version узнавать путем открытия renga-проекта как ZIP-файла, см. файл metadata, тэг AppVersion

## 2.5 Таблица stdl

> Сведения об STDL-файлах

| Name        | Type    | Description                                                       | Comment               |
| ----------- | ------- | ----------------------------------------------------------------- | --------------------- |
| rowid       | INTEGER | Индекс строки                                                     | NOT NULL, PRIMARY KEY |
| geom_rowid  | INTEGER | Идентификатор из таблицы bindata для файла описания геометрии lua |                       |
| props_rowid | INTEGER | Идентификатор из таблицы bindata для файла описания свойств json  |                       |
| rst_rowid   | INTEGER | Идентификатор из таблицы bindata для готового файла стиля RST     |                       |

## 2.6 Таблица icons

> base64-формат изображений объектов (PNG картинки разрешения 256x256)

| Name  | Type    | Description                                           | Comment               |
| ----- | ------- | ----------------------------------------------------- | --------------------- |
| rowid | INTEGER | Индекс строки                                         | NOT NULL, PRIMARY KEY |
| data  | BLOB    | Двоичное содержимое файла изображения (в виде base64) | NOT NULL              |

## 2.7 Таблица styles

> Сведения о стилях

| Name           | Type    | Description                                                                                                                          | Comment               |
| -------------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------ | --------------------- |
| rowid          | INTEGER | Индекс строки                                                                                                                        | NOT NULL, PRIMARY KEY |
| type           | INTEGER | 0 = данные в проекте, 1 = stdl                                                                                                       | NOT NULL              |
| data_rowid     | INTEGER | Идентификатор из таблицы projects, если type = 0 или stdl, если type = 1                                                             |                       |
| unique_id      | TEXT    | Идентификатор элемента (UniqueId в Renga-файле для ModelObject) или entityTypeId в styleParameters.params STDL-файла                 | NOT NULL              |
| category_id    | TEXT    | Id категории элемента в Renga                                                                                                        | NOT NULL              |
| icons_rowid    | INTEGER | Идентификатор изображения стиля из таблицы icons                                                                                     | NOT NULL              |
| name           | TEXT    | Наименование элемента (Name в Renga-файле или defaultName в metadata STDL-файла)                                                     | NOT NULL              |
| description    | TEXT    | Описание элемента (ничего в Renga-файле или description в metadata STDL-файла)                                                       |                       |
| version        | TEXT    | Версия Renga-файла, в котором сохранено описание. Если сохранено в STDL, то = минимальной поддерживаемой версии (1.0 -- 7; 1.1 -- 8) | NOT NULL              |
| geometry_rowid | INTEGER | Идентификатор кэшированной графики из таблицы geometry                                                                               |                       |
| sizes          | TEXT    | Список типоразмеров, разделенных символом "\|"                                                                                       |                       |

## 2.8. Таблица geometry

> Кэшированная геометрия (mesh) для объекта, используется для отрисовки картинок, просмотра сцен и сохранения в OBJ

| Name  | Type    | Description                                                           | Comment               |
| ----- | ------- | --------------------------------------------------------------------- | --------------------- |
| rowid | INTEGER | Индекс строки                                                         | NOT NULL, PRIMARY KEY |
| data  | BLOB    | Двоичное представление архива tar с OBJ + MLT (текстурированный mesh) | NOT NULL              |

Перед обработкой геометрии делать её сдвиг в "ноль координат", чтобы избежать хранение "больших" чисел в памяти и для последующей визуализации элемента.

# 3. Требуемые функции

Здесь будут описаны функции, которые необходимо реализовать. Для удобства отслеживания целевой среды будем использовать сокращения:

* LIB: основная библиотека классов (dll);
* APP: пользовательское настольное приложение -- обозреватель БД, формы редактирования и прочее;
* RP: renga-plugin, функции плагина в Renga;

## 3.1. Функции для ядра (LIB)

| Название функции                                      | Описание функции                                                                                                                                                                                               |
| ----------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Создание служебного каталога\инициализация приложения | Создание на ПК папки, куда будет осуществляться запись логов, временных файлов, храниться БД по умолчанию;                                                                                                     |
| Импорт стилей                                         | Вызов диалога открытия файлов и выбор папки/файлов STDL (одним файлом считается одноименная пара lua-json). При наличии там же RST будет обработан и он, при его отсутствии он будет сформирован автоматически |
| Задать RstBuilder                                     | Задать путь к RstBuilder.exe + StyleTemplate.dll, если используется версия не из STDLSDK                                                                                                                       |
| Ручное редактирование карточки стиля                  | Вывод и редактирование информации о стиле (таблица styles)                                                                                                                                                     |
| Обновление иконок - табл. icons                       | Для кэшированной геометрии запустить рендер иконок стилей                                                                                                                                                      |
| Очистка кэша геометрии                                | Очистка табл. geometry                                                                                                                                                                                         |
| Создать отчет                                         | Настройки создания отчета с картинками по всех Библиотеке в PDF (?)                                                                                                                                            |

## 3.2 Функции для приложения (APP)

Реализация всего что в 3.1, только в оконном режиме

## 3.3 Функции для плагина (RP)

| Название функции                                    | Описание функции                                                                                                                                                                       |
| --------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Найти                                               | Немодальное окно с текстовой строкой ввода для поиска среди всех стилей нужного по имени и\или описанию и типоразмеру (?). Возможность вставки элемента (**подумать как реализовать**) |
| Импорт проекта(-ов)                                 | Вызов диалога открытия файлов, выбор одного или нескольких файлов renga, их итеративное чтение на предмет получения всех определений стилей из файла и записи в БД                     |
| Обновление (кэширование) геометрии - табл. geometry | Чтение всех записей о стилях, если stdl -- вставка в проекта renga, чтение геометрии и закрытие                                                                                        |

Подумать ещё...
